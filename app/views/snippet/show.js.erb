<% widgetName = 'BlogTextsWidget' %>

var <%= widgetName %> = {
  circleStyles: { backgroundColor: 'black', height: '50px', width: '50px', borderRadius: '50%', position: 'absolute', bottom: '10px', right: '10px', cursor: 'pointer' },
  position: 'bottom_right',
  welcome_message: 'Send me a line', // TODO: get these from the database
  formHtml: '<%= j render "form" %>',
  formId: 'new_message',
  cssStyles: '<%= asset_url("tailwind.css") %>',
  thankYouHtml: '<p id="<%= widgetName %>_thank_you" class="py-4 px-4">Thanks for your message!</p>',

  init: function() {
    console.log('widget initialized!');
    this.showIcon();
    this.plantCss();
  },

  plantCss: function() {
    let stylesheet = document.createElement('link');
    stylesheet.rel = 'stylesheet';
    stylesheet.href = this.cssStyles;
    document.head.append(stylesheet);
  },

  showForm: function() {
    document.body.insertAdjacentHTML('beforeend', this.formHtml);
    document.getElementById('blog_text_widget_hide_form_button').addEventListener('click', this.hideForm.bind(this));
    document.getElementById(this.formId).addEventListener('submit', this.submitForm);
    this.enableAutosave();
    this.hideIcon();
  },

  enableAutosave: function() {
    ['name', 'email'].forEach(function(formField) {
      // attach autosave functionality to name, email form fields
      let fieldEl = document.getElementById('message_' + formField);

      fieldEl.addEventListener('change', function() {
        localStorage.setItem('<%= widgetName %>' + '_' + formField, fieldEl.value);
      })

      // retrieve existing autosaved value; if exists, prefill input
      let savedValue = localStorage.getItem('<%= widgetName %>' + '_' + formField);

      if (savedValue != null) {
        fieldEl.value = savedValue;
      }
    })
  },

  hideForm: function() {
    document.getElementById('blog_text_widget').remove();
    this.showIcon();
  },

  hideIcon: function() {
    document.getElementById('blog_text_icon').remove();
  },

  showIcon: function() {
    let icon = document.createElement('span');
    icon.id = 'blog_text_icon';
    icon.addEventListener('click', this.showForm.bind(this));
    Object.assign(icon.style, this.circleStyles);

    document.body.append(icon);
  },

  showThankYou: function() {
    document.getElementById(this.formId).innerHTML = this.thankYouHtml;
    setTimeout(this.hideForm.bind(this), 2000);
  },

  submitForm: function(e) {
    e.preventDefault();
    let form = e.target;

    fetch(form.action, {
      method: 'POST',
      body: new FormData(form)
    }).then((response) => {
      <%= widgetName %>.showThankYou();
    })
  }
}

<%= widgetName %>.init();
